<!-- Yan Pan 2023 -->
[% extends "base.html" %]

[% block head %] 
<title>Login</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<style>
    h1 {
        font-size: 2rem;
    }
    .container {
        width: 50%;
    }
</style>
[% endblock %]

[% block main %]
<div id="app">
    <div id="row-info" class="row">
        <div v-if="message" @click="message=''" class="card yellow lighten-5">
            <div class="card-content orange-text">System Message<br/>{{message}}</div>
            <div class="card-action"><a @click="message=''">Close</a></div>
        </div>
    </div>

    <div v-if="me.username">
        <h1>Welcome back {{me.full_name}}</h1>
        <p>
            <a class="waves-effect waves-light btn-large" href="[[ url_for('login_success_page') ]]">Manage Account</a>
        </p>
        <p>
            <a class="waves-effect waves-light btn-large " @click="logout">Logout</a>
        </p>
    </div>
    <div v-else class="row">
        <h1>Please login</h1>
        <p>
            The login requirement is to prompt responsible and fair use of AI.
        </p>
        <p>
            <a class="waves-effect waves-light btn-large" href="[[ url_for('login_google') ]]">Google Login</a>
        </p>
        <p>
            <a class="waves-effect waves-light btn-large" href="[[ url_for('login_github') ]]">Github Login</a>
        </p>
        <p>
            <a @click="showForm=1;">Login with Username/Password</a>
        </p>
        <div v-if="showForm" class="col s12 z-depth-6 card-panel">
            <form>
                <div class="row">
                </div>
                <div class="row input-field">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">person_outline</i>
                        <input id="username" type="text" v-model="username">
                        <label for="username">username</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">lock_outline</i>
                        <input id="password" type="password" v-model="password">
                        <label for="password">password</label>
                    </div>
                </div>
                <div class="row" v-if="showRegister">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">mail_outline</i>
                        <input id="email" type="email" v-model="email">
                        <label for="email">email</label>
                    </div>
                </div>
                <div class="row" v-if="showRegister">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">tag_faces</i>
                        <input id="fullname" type="text" v-model="fullname">
                        <label for="fullname">full name</label>
                    </div>
                </div>
                <div class="row" v-if="!showRegister"> 
                    <div class="input-field col s12">
                        <label>
                            <input type="checkbox" id="remember-me" />
                            <span>Remember me</span>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <a v-if="showRegister" @click="register" class="btn waves-effect waves-light col s12 disabled">
                            direct sign up not open. Use Google Login above.
                        </a>
                        <a v-else @click="login" class="btn waves-effect waves-light col s12">Login</a>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s6 m6 l6">
                        <p v-if="!showRegister" class="margin medium-small" @click="showSignUp"><a href="#">Register Now!</a></p>
                        <p v-if="showRegister" class="margin medium-small" @click="showRegister=1-showRegister"><a href="#">Existing user login</a></p>
                    </div>
                    <div class="input-field col s6 m6 l6">
                        <p class="margin right-align medium-small"  @click="showForm=0"><a href="#">Close</a></p>
                    </div>          
                </div>
        </form>
    </div>

    <hr style="margin-top: 100px;">
    <p>
        Your privacy is guaranteed! This app does NOT collect any personal information.<br>
        Token usage information may be logged with username, 
        but does not contain any chat content nor further user-specific information<br/>
        After login, you will be presented with all information collected, 
        which can be deleted with a click.
        Database is provided by Mongo Atlas.
    </p>
    </div>
    
</div>
[% endblock %]

[% block after %]
[% endblock %]

[% block vuejs %]
<script>
    // https upgrade in base header
    var url_me = "[[ url_for('check_bearer_token') ]]";
    var url_logout = "[[ url_for('clear_session') ]]";
    var url_token = "[[ url_for('login_for_access_token') ]]";
    var url_success = "[[ url_for('login_success_page') ]]";

    const {createApp} = Vue;

    createApp({
        data() {
            return {
                message: '',
                showForm: 0,
                showRegister: 0,
                me: {"username": undefined},
                username: '',
                password: '',
                email: '',
                fullname: ''
            }
        },
        created() {
            this.headers = {'Authorization': 'Bearer ' + window.localStorage.getItem("jwt")}
            fetch(url_me, {method: 'GET', headers: this.headers})
                .then(response => response.json())
                .then(data => {this.me = data; this.message='';})
                .catch(error => {console.error(error); this.message = error;});  
        },
        methods: {
            logout(){
                window.localStorage.removeItem("jwt");
                fetch(url_logout, {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {this.me = {}; this.message='Logout Successful';})
                    .catch(error => {console.error(error); this.message = error;});  
            },

            login(){
                fetch(url_token, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'},
                    body: `username=${this.username}&password=${this.password}`
                })
                    .then(response => {
                        if (response.ok) {
                            console.log("login success, redirect")
                            window.location.replace(url_success);
                        } else{
                            this.username = ""
                            this.password = ""
                            this.message = "Incorrect username or password"
                        }
                    })
                    .catch(error => this.message = error);
            },

            showSignUp(){
                this.showRegister = 1;
                this.message = "Standard registration is NOT open at this moment. Please use Google Login."
            }
        }
    }).mount("#app");
    </script>
[% endblock %]
